<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReelRecon // SKELETON RIPPER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tactical.css') }}">
    <style>
        /* Skeleton Ripper Page Styles - Using tactical.css variables */
        .sr-page {
            min-height: 100vh;
            padding: var(--space-lg);
        }

        .sr-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .sr-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
        }

        .sr-title {
            display: flex;
            align-items: baseline;
            gap: var(--space-md);
        }

        .sr-title h1 {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            color: var(--color-accent-primary);
            margin: 0;
            text-shadow: 0 0 20px var(--color-accent-glow);
        }

        .sr-title .subtitle {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--color-text-muted);
            text-decoration: none;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .back-link:hover {
            color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            background: var(--color-accent-muted);
        }

        /* Main Grid - 3 columns: Config | Results | History */
        .sr-grid {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: var(--space-lg);
            align-items: start;
        }

        .sr-grid > .sr-panel {
            margin-top: 0 !important;
            margin-bottom: 0;
            align-self: start;
        }

        /* Mission History Styles */
        .history-panel {
            max-height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
            margin: 0;  /* Reset any margins */
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border-dim);
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-item:hover {
            border-color: var(--color-accent-primary);
            background: var(--color-accent-dim);
        }

        .history-item.active {
            border-color: var(--color-accent-primary);
            background: var(--color-accent-muted);
        }

        .history-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }

        .history-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--color-text-muted);
        }

        .history-meta .platform {
            color: var(--color-accent-secondary);
            text-transform: uppercase;
        }

        .history-creator {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--color-accent-primary);
            cursor: help;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-creator:hover .creator-tooltip {
            display: block;
        }

        .creator-tooltip {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            background: var(--color-bg-panel);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 0.65rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .creator-tooltip div {
            margin-bottom: 1px;
        }

        .history-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 8px;
            background: var(--color-bg-input);
            border-radius: 4px;
            min-width: 40px;
        }

        .history-stat .count {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            line-height: 1;
        }

        .history-stat .label {
            font-family: var(--font-mono);
            font-size: 0.5rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
        }

        .history-empty {
            text-align: center;
            padding: var(--space-lg);
            color: var(--color-text-muted);
            font-size: 0.8rem;
        }

        /* Panels */
        .sr-panel {
            background: var(--color-bg-panel);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .panel-header {
            background: var(--color-bg-elevated);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .panel-status {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--color-text-muted);
        }

        .panel-body {
            padding: var(--space-md);
        }

        /* Config Sections */
        .config-section {
            margin-bottom: var(--space-lg);
        }

        .config-section:last-child {
            margin-bottom: 0;
        }

        .section-label {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--color-border-dim);
        }

        /* Username Inputs */
        .username-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .username-row {
            display: flex;
            gap: var(--space-xs);
            align-items: center;
        }

        .username-row .input-wrapper {
            flex: 1;
        }

        .remove-btn {
            background: transparent;
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: var(--color-danger);
            color: var(--color-bg-deep);
        }

        .add-btn {
            background: transparent;
            border: 1px dashed var(--color-border);
            color: var(--color-text-muted);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            transition: all 0.2s;
            margin-top: var(--space-xs);
            width: 100%;
        }

        .add-btn:hover:not(:disabled) {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .add-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Provider Status */
        .provider-status {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--space-sm);
        }

        .provider-status.ready {
            background: var(--color-accent-dim);
            color: var(--color-success);
            border: 1px solid var(--color-accent-primary);
        }

        .provider-status.unavailable {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
        }

        /* Start Button */
        .start-btn {
            width: 100%;
            padding: var(--space-md);
            background: var(--color-accent-primary);
            color: var(--color-bg-deep);
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 20px var(--color-accent-glow);
        }

        .start-btn:hover:not(:disabled) {
            background: #0ea271;
            transform: translateY(-1px);
            box-shadow: 0 0 30px var(--color-accent-glow);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Results Panel */
        .results-panel {
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .results-body {
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
            color: var(--color-text-muted);
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-md);
            opacity: 0.3;
            color: var(--color-accent-primary);
        }

        .empty-title {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
        }

        .empty-hint {
            font-size: 0.8rem;
            max-width: 300px;
            line-height: 1.5;
        }

        /* Progress Section */
        .progress-section {
            padding: var(--space-md);
        }

        .progress-phase {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--color-text-primary);
            margin-bottom: var(--space-sm);
        }

        .progress-bar-wrap {
            height: 6px;
            background: var(--color-bg-input);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: var(--space-md);
            border: 1px solid var(--color-border-dim);
        }

        .progress-bar {
            height: 100%;
            background: var(--color-accent-primary);
            box-shadow: 0 0 10px var(--color-accent-glow);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
        }

        .stat-box {
            text-align: center;
            padding: var(--space-sm);
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border-dim);
            border-radius: var(--radius-sm);
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            color: var(--color-accent-primary);
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.6rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
        }

        /* Results Body - Scrollable Container */
        .results-body {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* Report Content - Tactical & Professional */
        .report-content {
            font-family: var(--font-sans);
            line-height: 1.6;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .report-content h1 {
            font-size: 1.4rem;
            color: var(--color-accent-primary);
            margin: 0 0 var(--space-lg) 0;
            padding-bottom: var(--space-sm);
            font-family: var(--font-mono);
            font-weight: 600;
            letter-spacing: 0.02em;
            border-bottom: 2px solid var(--color-accent-primary);
        }

        .report-content h2 {
            font-size: 1rem;
            color: var(--color-accent-primary);
            margin: var(--space-xl) 0 var(--space-md) 0;
            padding: var(--space-sm) var(--space-md);
            font-family: var(--font-mono);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(90deg, var(--color-accent-dim) 0%, transparent 100%);
            border-left: 3px solid var(--color-accent-primary);
        }

        .report-content h3 {
            font-size: 0.95rem;
            color: var(--color-text-primary);
            margin: var(--space-lg) 0 var(--space-sm) 0;
            font-family: var(--font-mono);
            font-weight: 600;
        }

        .report-content h4 {
            font-size: 0.85rem;
            color: var(--color-accent-primary);
            margin: var(--space-md) 0 var(--space-xs) 0;
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .report-content p {
            margin: 0 0 var(--space-md) 0;
            color: var(--color-text-secondary);
        }

        .report-content ul, .report-content ol {
            margin: 0 0 var(--space-md) var(--space-lg);
            padding: 0;
        }

        .report-content li {
            margin-bottom: var(--space-sm);
            color: var(--color-text-secondary);
            position: relative;
        }

        .report-content li::marker {
            color: var(--color-accent-primary);
        }

        .report-content strong {
            color: var(--color-text-primary);
            font-weight: 600;
            display: inline;
        }

        /* Bold section headers in markdown - standalone lines */
        .report-content p > strong:only-child {
            display: block;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--color-accent-primary);
            margin: var(--space-md) 0 var(--space-xs) 0;
            padding: var(--space-xs) var(--space-sm);
            background: var(--color-bg-input);
            border-left: 2px solid var(--color-accent-primary);
        }

        .report-content em {
            color: var(--color-accent-secondary);
            font-style: normal;
        }

        .report-content code {
            background: var(--color-bg-input);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85em;
            color: var(--color-accent-primary);
            border: 1px solid var(--color-border-dim);
        }

        .report-content pre {
            background: var(--color-bg-input);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            border-left: 3px solid var(--color-accent-primary);
            overflow-x: auto;
            margin: var(--space-md) 0;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .report-content pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--color-text-secondary);
            font-size: inherit;
        }

        .report-content hr {
            border: none;
            border-top: 1px solid var(--color-border);
            margin: var(--space-xl) 0;
        }

        /* Skeleton Template Cards */
        .report-content .skeleton-card {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin: var(--space-md) 0;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 12px 20px;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-accent-primary);
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--color-text-primary);
            box-shadow: 0 4px 20px rgba(0, 255, 157, 0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-color: var(--color-status-success);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        .toast.error {
            border-color: var(--color-status-error);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }

        /* Tab Toolbar (sticky at top of content) */
        .tab-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tab-toolbar-left {
            display: flex;
            gap: 8px;
        }

        .tab-toolbar-right {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .toolbar-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
            background: var(--color-accent-dim);
        }

        .toolbar-btn.active {
            background: var(--color-accent-dim);
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .toolbar-btn.primary {
            background: var(--color-accent-dim);
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .report-actions {
            display: none; /* Hidden - moved to toolbar */
        }

        .action-btn {
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .action-btn.primary {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: var(--color-bg-deep);
        }

        .action-btn.primary:hover {
            background: #0ea271;
        }

        /* Report Tabs */
        .report-tabs-container {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .report-tabs-container.active {
            display: flex;
        }

        .report-tabs-nav {
            display: flex;
            gap: 2px;
            padding: 0 var(--space-md);
            background: var(--color-bg-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        .tab-btn {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-muted);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--color-text-secondary);
            background: var(--color-bg-input);
        }

        .tab-btn.active {
            color: var(--color-accent-primary);
            border-bottom-color: var(--color-accent-primary);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        .tab-content.active {
            display: block;
        }

        /* Tab 1: Visual Skeletons */
        .skeleton-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .skeleton-card {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .skeleton-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--color-bg-input);
            border-bottom: 1px solid var(--color-border-dim);
        }

        .skeleton-creator {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--color-accent-primary);
        }

        .skeleton-meta {
            display: flex;
            gap: var(--space-md);
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--color-text-muted);
        }

        .skeleton-card-body {
            padding: var(--space-md);
        }

        .skeleton-section {
            margin-bottom: var(--space-md);
        }

        .skeleton-section:last-child {
            margin-bottom: 0;
        }

        .skeleton-label {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--color-accent-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }

        .skeleton-hook {
            font-size: 0.95rem;
            color: var(--color-text-primary);
            font-weight: 500;
            line-height: 1.4;
            padding: var(--space-sm);
            background: var(--color-accent-dim);
            border-left: 3px solid var(--color-accent-primary);
            border-radius: 0 4px 4px 0;
        }

        .skeleton-value {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .skeleton-points {
            margin-top: var(--space-xs);
            padding-left: var(--space-md);
        }

        .skeleton-points li {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .skeleton-points li::marker {
            color: var(--color-accent-primary);
        }

        .skeleton-cta {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        .skeleton-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: var(--space-sm);
        }

        .skeleton-tag {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            padding: 2px 8px;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border-dim);
            border-radius: 3px;
            color: var(--color-text-muted);
        }

        .skeleton-tag.technique {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .skeleton-tag.structure {
            border-color: var(--color-accent-secondary);
            color: var(--color-accent-secondary);
        }

        /* Skeleton Card Actions - Compact inline style */
        .skeleton-card-actions {
            display: flex;
            gap: 12px;
            padding: 6px var(--space-md) 8px;
            border-top: 1px solid var(--color-border-dim);
        }

        .skeleton-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 0;
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-family: var(--font-mono);
            font-size: 0.6rem;
            letter-spacing: 0.03em;
            cursor: pointer;
            transition: color 0.15s;
            text-transform: uppercase;
        }

        .skeleton-action-btn:hover {
            color: var(--color-accent-primary);
        }

        .skeleton-action-btn.video-btn.downloaded {
            color: var(--color-success);
        }

        .skeleton-action-btn.video-btn.downloading {
            color: var(--color-warning);
            cursor: wait;
        }

        .skeleton-action-btn svg {
            flex-shrink: 0;
            width: 12px;
            height: 12px;
        }

        /* REEL INTEL Modal Styles */
        .reel-intel-stats {
            display: flex;
            gap: var(--space-xl);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border-dim);
        }

        .reel-stat {
            display: flex;
            flex-direction: column;
        }

        .reel-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-primary);
            line-height: 1;
        }

        .reel-stat-label {
            font-size: 0.6rem;
            color: var(--color-text-muted);
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        .reel-intel-section {
            margin-bottom: var(--space-md);
        }

        .reel-intel-label {
            font-size: 0.65rem;
            color: var(--color-text-muted);
            letter-spacing: 0.1em;
            margin-bottom: 6px;
        }

        .reel-intel-url-row {
            display: flex;
            gap: var(--space-sm);
        }

        .reel-intel-url {
            flex: 1;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            padding: 8px 12px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .reel-intel-copy-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .reel-intel-copy-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .reel-intel-hook {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .reel-intel-transcript {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: var(--space-md);
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .reel-intel-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .reel-intel-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
            text-decoration: none;
        }

        .reel-intel-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .reel-intel-btn.primary {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: var(--color-bg-deep);
        }

        .reel-intel-btn.primary:hover {
            background: #059669;
        }

        .reel-intel-btn.downloaded {
            background: transparent;
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .reel-intel-btn.downloading {
            border-color: var(--color-warning);
            color: var(--color-warning);
            cursor: wait;
        }

        /* Tab 2: Markdown View */
        .markdown-toggle {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .markdown-toggle .tab-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        .markdown-toggle .tab-btn.active {
            background: var(--color-accent-dim);
            border-color: var(--color-accent-primary);
        }

        .markdown-raw {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--color-text-secondary);
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }

        /* Tab 3: JSON View */
        .json-view {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--color-text-secondary);
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .json-view .key { color: var(--color-accent-secondary); }
        .json-view .string { color: var(--color-success); }
        .json-view .number { color: var(--color-accent-primary); }
        .json-view .boolean { color: #f59e0b; }
        .json-view .null { color: var(--color-text-muted); }

        /* Tab 4: AI Prompt */
        .ai-prompt-section {
            margin-bottom: var(--space-lg);
        }

        .ai-prompt-section h3 {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--color-accent-primary);
            margin-bottom: var(--space-sm);
        }

        .ai-prompt-section p {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-md);
        }

        .ai-prompt-box {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-prompt-btn {
            margin-top: var(--space-md);
        }

        /* Error Display */
        .error-box {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-danger);
            border-radius: var(--radius-sm);
        }

        .error-box h4 {
            color: var(--color-danger);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            margin-bottom: var(--space-xs);
        }

        .error-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .error-box li {
            font-size: 0.8rem;
            color: var(--color-danger);
            padding: var(--space-xs) 0;
        }

        @media (max-width: 1400px) {
            .sr-grid {
                grid-template-columns: 350px 1fr;
            }
            .history-panel {
                display: none;
            }
        }

        @media (max-width: 1024px) {
            .sr-grid {
                grid-template-columns: 1fr;
            }

            .results-panel {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Scan Lines Overlay -->
    <div class="scan-lines"></div>

    <!-- Corner HUD Elements -->
    <div class="corner-hud top-left">
        <div class="hud-bracket"></div>
        <span class="hud-label">SR.ACTIVE</span>
    </div>
    <div class="corner-hud top-right">
        <div class="hud-bracket"></div>
        <span class="hud-label" id="clock">--:--:--</span>
    </div>
    <div class="corner-hud bottom-left">
        <div class="hud-bracket"></div>
        <span class="hud-label">v2.1.0-alpha</span>
    </div>
    <div class="corner-hud bottom-right">
        <div class="hud-bracket"></div>
        <span class="hud-label" id="statusLabel">READY</span>
    </div>

    <div class="sr-page">
        <div class="sr-container">
            <!-- Header -->
            <div class="sr-header">
                <div class="sr-title">
                    <h1>// SKELETON RIPPER</h1>
                    <span class="subtitle">Multi-Creator Content Pattern Analysis</span>
                </div>
                <a href="/" class="back-link">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    BACK TO RECON
                </a>
            </div>

            <!-- Main Grid -->
            <div class="sr-grid">
                <!-- Config Panel -->
                <div class="sr-panel">
                    <div class="panel-header">
                        <span class="panel-title">// Mission Config</span>
                    </div>
                    <div class="panel-body">
                        <!-- Creators Section -->
                        <div class="config-section">
                            <div class="section-label">Target Creators</div>
                            <div class="username-list" id="usernameList">
                                <div class="username-row">
                                    <div class="input-wrapper">
                                        <span class="input-prefix">@</span>
                                        <input type="text" class="form-input username-input" placeholder="creator_username">
                                    </div>
                                </div>
                            </div>
                            <button class="add-btn" id="addUsernameBtn" onclick="addUsername()">
                                + ADD CREATOR (MAX 5)
                            </button>
                        </div>

                        <!-- Platform Section -->
                        <div class="config-section">
                            <div class="section-label">Platform</div>
                            <div class="platform-toggle">
                                <button type="button" class="platform-btn active" data-platform="instagram" onclick="selectPlatform('instagram')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <rect x="2" y="2" width="20" height="20" rx="5"/>
                                        <circle cx="12" cy="12" r="4"/>
                                        <circle cx="18" cy="6" r="1.5" fill="currentColor"/>
                                    </svg>
                                    INSTAGRAM
                                </button>
                                <button type="button" class="platform-btn disabled" data-platform="tiktok" title="Coming Soon" disabled>
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                                        <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                                    </svg>
                                    TIKTOK
                                    <span class="coming-soon-badge">SOON</span>
                                </button>
                            </div>
                        </div>

                        <!-- Videos Per Creator -->
                        <div class="config-section">
                            <div class="section-label">Videos Per Creator</div>
                            <div class="form-group">
                                <select id="videosPerCreator" class="form-input">
                                    <option value="1">1 video</option>
                                    <option value="2">2 videos</option>
                                    <option value="3" selected>3 videos (recommended)</option>
                                    <option value="4">4 videos</option>
                                    <option value="5">5 videos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Transcription Section -->
                        <div class="config-section">
                            <div class="section-label">Transcription</div>
                            <div class="form-group">
                                <label class="form-label">WHISPER PROVIDER</label>
                                <select id="transcribeProvider" class="form-input" onchange="updateWhisperModels()">
                                    <option value="openai">OpenAI Whisper API</option>
                                    <option value="local">Local Whisper</option>
                                </select>
                            </div>
                            <div class="form-group" id="whisperModelGroup" style="display: none;">
                                <label class="form-label">LOCAL MODEL</label>
                                <select id="whisperModel" class="form-input">
                                    <option value="tiny.en">tiny.en (fastest)</option>
                                    <option value="base.en">base.en</option>
                                    <option value="small.en" selected>small.en (recommended)</option>
                                    <option value="medium.en">medium.en</option>
                                    <option value="large">large (most accurate)</option>
                                </select>
                            </div>
                        </div>

                        <!-- LLM Provider Section -->
                        <div class="config-section">
                            <div class="section-label">LLM for Analysis</div>
                            <div class="form-group">
                                <label class="form-label">PROVIDER</label>
                                <select id="llmProvider" class="form-input" onchange="updateModels()">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">MODEL</label>
                                <select id="llmModel" class="form-input">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div id="providerStatus" class="provider-status ready">Ready</div>
                        </div>

                        <!-- Start Button -->
                        <button class="start-btn" id="startBtn" onclick="startAnalysis()">
                            INITIATE ANALYSIS
                        </button>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="sr-panel results-panel">
                    <div class="panel-header">
                        <span class="panel-title">// Analysis Results</span>
                        <span class="panel-status" id="resultsStatus">Awaiting input</span>
                    </div>
                    <div class="results-body" id="resultsBody">
                        <div class="empty-state" id="emptyState">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                                <path d="M9 12h6M9 16h6"/>
                            </svg>
                            <div class="empty-title">NO ANALYSIS RUNNING</div>
                            <div class="empty-hint">Enter 1-5 creator usernames and click "Initiate Analysis" to extract content patterns</div>
                        </div>

                        <div class="progress-section" id="progressSection" style="display: none;">
                            <div class="progress-phase" id="progressPhase">Initializing...</div>
                            <div class="progress-bar-wrap">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                            <div class="progress-stats">
                                <div class="stat-box">
                                    <div class="stat-value" id="statScraped">0</div>
                                    <div class="stat-label">Downloaded</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="statTranscribed">0</div>
                                    <div class="stat-label">Transcribed</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="statExtracted">0</div>
                                    <div class="stat-label">Skeletons</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="statCached">0</div>
                                    <div class="stat-label">From Cache</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-content" id="reportContent" style="display: none;"></div>

                        <!-- Tabbed Report Interface -->
                        <div class="report-tabs-container" id="reportTabs">
                            <div class="report-tabs-nav">
                                <button class="tab-btn active" onclick="switchTab('visual')">Skeletons</button>
                                <button class="tab-btn" onclick="switchTab('markdown')">Markdown</button>
                                <button class="tab-btn" onclick="switchTab('json')">JSON</button>
                                <button class="tab-btn" onclick="switchTab('prompt')">AI Prompt</button>
                            </div>

                            <!-- Tab 1: Visual Skeletons -->
                            <div class="tab-content active" id="tab-visual">
                                <div class="tab-toolbar">
                                    <div class="tab-toolbar-left">
                                        <span style="font-size: 0.7rem; color: var(--color-text-muted);">Visual skeleton cards</span>
                                    </div>
                                    <div class="tab-toolbar-right">
                                        <button class="toolbar-btn" onclick="downloadReport()">Download Report</button>
                                        <button class="toolbar-btn" onclick="newAnalysis()">New Analysis</button>
                                    </div>
                                </div>
                                <div class="skeleton-grid" id="skeletonGrid"></div>
                            </div>

                            <!-- Tab 2: Markdown -->
                            <div class="tab-content" id="tab-markdown">
                                <div class="tab-toolbar">
                                    <div class="tab-toolbar-left">
                                        <button class="toolbar-btn active" id="mdPreviewBtn" onclick="toggleMarkdownView('preview')">Preview</button>
                                        <button class="toolbar-btn" id="mdRawBtn" onclick="toggleMarkdownView('raw')">Raw</button>
                                    </div>
                                    <div class="tab-toolbar-right">
                                        <button class="toolbar-btn primary" onclick="copyMarkdown()">Copy</button>
                                        <button class="toolbar-btn" onclick="downloadMarkdown()">Download</button>
                                    </div>
                                </div>
                                <div id="markdownPreview" class="report-content"></div>
                                <div id="markdownRaw" class="markdown-raw" style="display: none;"></div>
                            </div>

                            <!-- Tab 3: JSON -->
                            <div class="tab-content" id="tab-json">
                                <div class="tab-toolbar">
                                    <div class="tab-toolbar-left">
                                        <span style="font-size: 0.7rem; color: var(--color-text-muted);">Raw JSON data</span>
                                    </div>
                                    <div class="tab-toolbar-right">
                                        <button class="toolbar-btn primary" onclick="copyJson()">Copy</button>
                                        <button class="toolbar-btn" onclick="downloadJson()">Download</button>
                                    </div>
                                </div>
                                <div class="json-view" id="jsonView"></div>
                            </div>

                            <!-- Tab 4: AI Prompt -->
                            <div class="tab-content" id="tab-prompt">
                                <div class="tab-toolbar">
                                    <div class="tab-toolbar-left">
                                        <span style="font-size: 0.7rem; color: var(--color-text-muted);">Script generation prompt</span>
                                    </div>
                                    <div class="tab-toolbar-right">
                                        <button class="toolbar-btn primary" onclick="copyAiPrompt()">Copy Prompt</button>
                                    </div>
                                </div>
                                <div class="ai-prompt-section">
                                    <p>Copy this prompt into ChatGPT, Claude, or your preferred AI to collaboratively create scripts based on these proven skeleton patterns.</p>
                                    <div class="ai-prompt-box" id="aiPromptBox"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mission History Panel -->
                <div class="sr-panel history-panel">
                    <div class="panel-header">
                        <span class="panel-title">// Mission History</span>
                        <button class="action-btn" onclick="loadHistory()" style="padding: 2px 8px; font-size: 0.65rem;">
                             REFRESH
                        </button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="history-empty">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Download Modal -->
    <div class="modal" id="downloadModal">
        <div class="modal-backdrop" onclick="closeDownloadModal()"></div>
        <div class="modal-content download-modal">
            <div class="modal-header">
                <span class="modal-title">MODEL DOWNLOAD REQUIRED</span>
            </div>
            <div class="modal-body">
                <div class="download-info">
                    <div class="download-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </div>
                    <div class="download-text">
                        <p>The <strong id="downloadModelName">small.en</strong> Whisper model is not installed.</p>
                        <p>It will be downloaded automatically on first use.</p>
                    </div>
                </div>
                <div class="download-details">
                    <div class="detail-row">
                        <span class="detail-label">MODEL SIZE</span>
                        <span class="detail-value" id="downloadModelSize">~244 MB</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">EST. TIME</span>
                        <span class="detail-value" id="downloadEstTime">1-3 minutes</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">LOCATION</span>
                        <span class="detail-value">~/.cache/whisper/</span>
                    </div>
                </div>
                <div class="download-note">
                    <strong>Note:</strong> This is a one-time download. The model will be cached locally for future use.
                </div>
                <div class="modal-actions">
                    <button class="modal-btn" onclick="closeDownloadModal()">CANCEL</button>
                    <button class="modal-btn primary" onclick="confirmDownload()">CONTINUE &amp; DOWNLOAD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skeleton Detail Modal - REEL INTEL Style -->
    <div class="modal" id="skeletonDetailModal">
        <div class="modal-backdrop" onclick="closeSkeletonDetailModal()"></div>
        <div class="modal-content" style="max-width: 580px;">
            <div class="modal-header">
                <span class="modal-title">REEL INTEL</span>
                <button class="modal-close" onclick="closeSkeletonDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Stats Row -->
                <div class="reel-intel-stats" id="skeletonDetailStats">
                    <div class="reel-stat">
                        <span class="reel-stat-value" id="statViews">0</span>
                        <span class="reel-stat-label">VIEWS</span>
                    </div>
                    <div class="reel-stat">
                        <span class="reel-stat-value" id="statLikes">0</span>
                        <span class="reel-stat-label">LIKES</span>
                    </div>
                    <div class="reel-stat">
                        <span class="reel-stat-value" id="statDuration">0s</span>
                        <span class="reel-stat-label">DURATION</span>
                    </div>
                </div>

                <!-- URL Section -->
                <div class="reel-intel-section">
                    <div class="reel-intel-label">URL</div>
                    <div class="reel-intel-url-row">
                        <input type="text" id="skeletonDetailUrl" class="reel-intel-url" readonly>
                        <button class="reel-intel-copy-btn" onclick="copySkeletonUrl()">COPY</button>
                    </div>
                </div>

                <!-- Hook Section -->
                <div class="reel-intel-section">
                    <div class="reel-intel-label">HOOK</div>
                    <div id="skeletonDetailHook" class="reel-intel-hook"></div>
                </div>

                <!-- Transcript Section -->
                <div class="reel-intel-section">
                    <div class="reel-intel-label">TRANSCRIPT</div>
                    <div id="skeletonDetailTranscript" class="reel-intel-transcript"></div>
                </div>

                <!-- Action Buttons -->
                <div class="reel-intel-actions">
                    <a id="skeletonDetailLink" href="#" target="_blank" class="reel-intel-btn">OPEN IN IG</a>
                    <button class="reel-intel-btn primary" id="skeletonDetailDownloadBtn" onclick="handleDetailDownload()">DOWNLOAD</button>
                    <button class="reel-intel-btn" onclick="copySkeletonDetailTranscript()">DOWNLOAD TRANSCRIPT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skeleton Video Player Modal -->
    <div class="modal" id="skeletonVideoModal">
        <div class="modal-backdrop" onclick="closeSkeletonVideoModal()"></div>
        <div class="modal-content video-player-modal with-transcript" style="max-width: 850px;">
            <div class="modal-header">
                <span class="modal-title">VIDEO PLAYER</span>
                <button class="modal-close" onclick="closeSkeletonVideoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="video-player-layout">
                    <div class="video-player-main">
                        <div class="video-player-container">
                            <video id="skeletonVideoPlayer" controls>
                                <source id="skeletonVideoSource" src="" type="video/mp4">
                            </video>
                        </div>
                        <div class="video-player-info">
                            <div class="video-player-username" id="skeletonVideoUsername">@username</div>
                            <div class="video-player-stats" id="skeletonVideoStats">0 views  0 likes</div>
                        </div>
                    </div>
                    <div class="video-transcript-panel">
                        <div class="transcript-header">
                            <span class="transcript-title">TRANSCRIPT</span>
                            <div class="transcript-actions">
                                <button class="transcript-action-btn" onclick="copySkeletonTranscript()" title="Copy transcript">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="transcript-content" id="skeletonVideoTranscript" style="padding: var(--space-md); overflow-y: auto; flex: 1; font-size: 12px; line-height: 1.6; color: var(--color-text-secondary);">
                            Transcript will appear here...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // State
        let currentPlatform = 'instagram';
        let currentJobId = null;
        let pollInterval = null;
        let providersData = [];  // Array of provider objects
        let pendingAnalysis = null;  // For download modal flow
        let currentReportData = { markdown: '', json: [], reportId: null };  // Store report data
        let currentHistoryId = null;

        // Toast Notification System
        function showToast(message, type = 'success', duration = 2500) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Whisper model info for download modal
        const whisperModelInfo = {
            'tiny.en': { size: '39 MB', time: '30 sec - 1 min' },
            'base.en': { size: '74 MB', time: '1-2 minutes' },
            'small.en': { size: '244 MB', time: '1-3 minutes' },
            'medium.en': { size: '769 MB', time: '3-5 minutes' },
            'large': { size: '1.5 GB', time: '5-10 minutes' }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initClock();
            loadProviders();
        });

        // Clock
        function initClock() {
            function updateClock() {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Load available providers
        async function loadProviders() {
            try {
                const response = await fetch('/api/skeleton-ripper/providers');
                const data = await response.json();
                providersData = data.providers || [];
                populateProviders();
            } catch (error) {
                console.error('Failed to load providers:', error);
                document.getElementById('providerStatus').className = 'provider-status unavailable';
                document.getElementById('providerStatus').textContent = 'Failed to load providers';
            }
        }

        function populateProviders() {
            const select = document.getElementById('llmProvider');
            select.innerHTML = '';

            providersData.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = provider.name + (provider.available ? '' : ' (Not configured)');
                option.disabled = !provider.available;
                select.appendChild(option);
            });

            // Select first available provider
            const firstAvailable = providersData.find(p => p.available);
            if (firstAvailable) {
                select.value = firstAvailable.id;
            }

            updateModels();
        }

        function updateModels() {
            const providerId = document.getElementById('llmProvider').value;
            const provider = providersData.find(p => p.id === providerId);
            const modelSelect = document.getElementById('llmModel');
            const statusDiv = document.getElementById('providerStatus');

            modelSelect.innerHTML = '';

            if (!provider) {
                statusDiv.className = 'provider-status unavailable';
                statusDiv.textContent = 'No provider selected';
                return;
            }

            // Update status
            if (provider.available && provider.models && provider.models.length > 0) {
                statusDiv.className = 'provider-status ready';
                statusDiv.textContent = 'Ready';

                // Populate models
                provider.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name || model.id;
                    modelSelect.appendChild(option);
                });
            } else if (provider.available) {
                statusDiv.className = 'provider-status unavailable';
                statusDiv.textContent = 'No models available';
            } else {
                statusDiv.className = 'provider-status unavailable';
                statusDiv.textContent = 'API key not configured';
            }
        }

        // Transcription provider toggle
        function updateWhisperModels() {
            const provider = document.getElementById('transcribeProvider').value;
            const whisperModelGroup = document.getElementById('whisperModelGroup');

            if (provider === 'local') {
                whisperModelGroup.style.display = 'block';
            } else {
                whisperModelGroup.style.display = 'none';
            }
        }

        // Download modal functions
        function showDownloadModal(modelName) {
            const info = whisperModelInfo[modelName] || { size: 'Unknown', time: 'Unknown' };

            document.getElementById('downloadModelName').textContent = modelName;
            document.getElementById('downloadModelSize').textContent = `~${info.size}`;
            document.getElementById('downloadEstTime').textContent = info.time;

            document.getElementById('downloadModal').classList.add('active');
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('active');
            pendingAnalysis = null;
            resetStartButton();
        }

        function confirmDownload() {
            const analysisData = pendingAnalysis;
            document.getElementById('downloadModal').classList.remove('active');
            pendingAnalysis = null;

            if (analysisData) {
                // Update button to show downloading
                const startBtn = document.getElementById('startBtn');
                startBtn.textContent = 'DOWNLOADING MODEL...';

                executeAnalysis(analysisData);
            }
        }

        // Platform selection
        function selectPlatform(platform) {
            currentPlatform = platform;
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.platform === platform);
            });
        }

        // Username management
        function addUsername() {
            const list = document.getElementById('usernameList');
            const count = list.children.length;

            if (count >= 5) return;

            const row = document.createElement('div');
            row.className = 'username-row';
            row.innerHTML = `
                <div class="input-wrapper">
                    <span class="input-prefix">@</span>
                    <input type="text" class="form-input username-input" placeholder="creator_username">
                </div>
                <button class="remove-btn" onclick="removeUsername(this)">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `;
            list.appendChild(row);
            updateAddButton();
        }

        function removeUsername(btn) {
            btn.parentElement.remove();
            updateAddButton();
        }

        function updateAddButton() {
            const count = document.getElementById('usernameList').children.length;
            const btn = document.getElementById('addUsernameBtn');
            btn.disabled = count >= 5;
            btn.textContent = count >= 5 ? 'MAX CREATORS REACHED' : '+ ADD CREATOR (MAX 5)';
        }

        function getSelectedUsernames() {
            const inputs = document.querySelectorAll('.username-input');
            const usernames = [];
            inputs.forEach(input => {
                const value = input.value.trim().replace('@', '');
                if (value) usernames.push(value);
            });
            return usernames;
        }

        // Start analysis
        async function startAnalysis() {
            const usernames = getSelectedUsernames();

            if (usernames.length === 0) {
                showToast('Please enter at least one creator username', 'error');
                return;
            }

            const providerId = document.getElementById('llmProvider').value;
            const provider = providersData.find(p => p.id === providerId);

            if (!provider || !provider.available) {
                showToast('Please select an available LLM provider', 'error');
                return;
            }

            // Get transcription settings
            const transcribeProvider = document.getElementById('transcribeProvider').value;
            const whisperModel = document.getElementById('whisperModel').value;

            // Build analysis data
            const analysisData = {
                usernames: usernames,
                platform: currentPlatform,
                videos_per_creator: parseInt(document.getElementById('videosPerCreator').value),
                llm_provider: providerId,
                llm_model: document.getElementById('llmModel').value,
                transcribe_provider: transcribeProvider,
                whisper_model: whisperModel
            };

            // Disable start button
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'CHECKING...';

            // If using local transcription, check if model is installed
            if (transcribeProvider === 'local') {
                try {
                    const checkResponse = await fetch(`/api/whisper/check/${whisperModel}`);
                    const checkData = await checkResponse.json();

                    if (!checkData.installed) {
                        // Show download modal
                        pendingAnalysis = analysisData;
                        showDownloadModal(whisperModel);
                        return;
                    }
                } catch (error) {
                    console.warn('Could not check model status:', error);
                    // Continue anyway - model will download during analysis
                }
            }

            // Execute the analysis
            executeAnalysis(analysisData);
        }

        // Execute analysis with given data
        async function executeAnalysis(analysisData) {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'INITIATING...';

            // Show progress section
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('reportContent').style.display = 'none';
            document.getElementById('resultsStatus').textContent = 'Running';
            document.getElementById('statusLabel').textContent = 'ACTIVE';

            try {
                const response = await fetch('/api/skeleton-ripper/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisData)
                });

                const data = await response.json();

                if (data.success) {
                    currentJobId = data.job_id;
                    startPolling();
                } else {
                    throw new Error(data.error || 'Failed to start analysis');
                }
            } catch (error) {
                console.error('Failed to start analysis:', error);
                showToast('Failed to start analysis: ' + error.message, 'error');
                resetUI();
            }
        }

        // Polling
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(pollStatus, 2000);
            pollStatus();
        }

        async function pollStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/skeleton-ripper/status/${currentJobId}`);
                const data = await response.json();
                console.log('Poll response:', data.status, data.progress?.status, data.progress?.phase);

                if (data.success) {
                    // Update progress if available
                    if (data.progress) {
                        updateProgress(data.progress);
                    } else {
                        // Show initializing state
                        document.getElementById('progressPhase').textContent = 'Initializing pipeline...';
                    }

                    // Check job status (top-level, not progress.status)
                    // Also check progress.status for 'complete' as backup
                    const jobComplete = data.status === 'complete' || data.progress?.status === 'complete';
                    const jobFailed = data.status === 'failed' || data.progress?.status === 'failed';

                    if (jobComplete) {
                        console.log('Job complete! Loading report...');
                        stopPolling();
                        loadReport();
                    } else if (jobFailed) {
                        console.log('Job failed!');
                        stopPolling();
                        const errors = data.progress?.errors || data.result?.error || ['Unknown error'];
                        showError(Array.isArray(errors) ? errors : [errors]);
                    }
                }
            } catch (error) {
                console.error('Failed to poll status:', error);
            }
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function updateProgress(progress) {
            // Show phase with optional detailed message
            const phase = progress.phase || 'Processing...';
            const message = progress.message || '';

            // Build display text with phase and message
            let displayText = phase;
            if (message && message !== phase) {
                // Filter out stale Whisper messages during non-scraping phases
                const isStaleMessage = message.includes('Whisper') && !progress.status?.includes('scrap');
                if (!isStaleMessage) {
                    displayText = `${phase}  ${message}`;
                }
            }
            document.getElementById('progressPhase').textContent = displayText;

            // Update stats - show downloaded separately from transcribed
            const downloaded = progress.videos_downloaded || 0;
            const transcribed = progress.videos_transcribed || 0;
            document.getElementById('statScraped').textContent = downloaded;
            document.getElementById('statTranscribed').textContent = transcribed;
            document.getElementById('statExtracted').textContent = progress.skeletons_extracted || 0;
            document.getElementById('statCached').textContent = progress.transcripts_from_cache || 0;

            // Progress bar - show overall progress
            const total = progress.total_target || 1;
            const extracted = progress.skeletons_extracted || 0;

            // Weight: scraping/transcribing = 60%, extraction = 30%, synthesis = 10%
            let percent = 0;
            const status = progress.status || '';
            if (status === 'scraping' || status === 'transcribing') {
                percent = (transcribed / total) * 60;
            } else if (status === 'extracting') {
                // Show batch-based progress during extraction
                const batchProgress = progress.extraction_batch && progress.extraction_total_batches
                    ? (progress.extraction_batch / progress.extraction_total_batches)
                    : (extracted / total);
                percent = 60 + (batchProgress * 30);
            } else if (status === 'aggregating') {
                percent = 92;
            } else if (status === 'synthesizing') {
                percent = 95;
            } else if (status === 'complete') {
                percent = 100;
            }

            document.getElementById('progressBar').style.width = Math.min(percent, 100) + '%';
        }

        async function loadReport() {
            console.log('Loading report for job:', currentJobId);

            // Update UI to show loading state
            document.getElementById('progressPhase').textContent = 'Loading report...';
            document.getElementById('progressBar').style.width = '100%';

            try {
                // Fetch both markdown and JSON in parallel
                const [mdResponse, jsonResponse] = await Promise.all([
                    fetch(`/api/skeleton-ripper/report/${currentJobId}`),
                    fetch(`/api/skeleton-ripper/report/${currentJobId}/json`)
                ]);

                if (!mdResponse.ok) {
                    throw new Error(`Failed to fetch report: ${mdResponse.status}`);
                }

                const markdown = await mdResponse.text();
                let jsonData = [];
                if (jsonResponse.ok) {
                    jsonData = await jsonResponse.json();
                }

                // Store report data
                currentReportData = { markdown, json: jsonData, reportId: currentJobId };

                // Hide progress, show tabbed interface
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('reportContent').style.display = 'none';
                document.getElementById('reportTabs').classList.add('active');

                // Render all tabs
                renderVisualSkeletons(jsonData);
                renderMarkdownTab(markdown);
                renderJsonTab(jsonData);
                renderAiPromptTab(jsonData);

                // Update all status indicators
                document.getElementById('resultsStatus').textContent = 'Complete';
                document.getElementById('statusLabel').textContent = 'COMPLETE';
                document.getElementById('statusLabel').style.color = 'var(--color-success)';

                // Refresh history
                loadHistory();

                console.log('Report displayed successfully');
            } catch (error) {
                console.error('Failed to load report:', error);
                document.getElementById('progressPhase').textContent = 'Report generated but failed to display. Check output folder.';
                document.getElementById('resultsStatus').textContent = 'Error loading';
                document.getElementById('statusLabel').textContent = 'ERROR';
            } finally {
                resetStartButton();
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update nav buttons
            document.querySelectorAll('.report-tabs-nav .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName));
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function toggleMarkdownView(view) {
            const previewEl = document.getElementById('markdownPreview');
            const rawEl = document.getElementById('markdownRaw');
            const previewBtn = document.getElementById('mdPreviewBtn');
            const rawBtn = document.getElementById('mdRawBtn');

            if (view === 'preview') {
                previewEl.style.display = 'block';
                rawEl.style.display = 'none';
                previewBtn.classList.add('active');
                rawBtn.classList.remove('active');
            } else {
                previewEl.style.display = 'none';
                rawEl.style.display = 'block';
                previewBtn.classList.remove('active');
                rawBtn.classList.add('active');
            }
        }

        // Render visual skeleton cards
        // Store skeleton data for modal access
        let currentSkeletons = [];
        let skeletonVideoStatus = {};  // Track download status per video_id

        function renderVisualSkeletons(skeletons) {
            const grid = document.getElementById('skeletonGrid');
            currentSkeletons = skeletons || [];
            skeletonVideoStatus = {};  // Reset status tracking

            if (!skeletons || skeletons.length === 0) {
                grid.innerHTML = '<p style="color: var(--color-text-muted);">No skeleton data available.</p>';
                return;
            }

            grid.innerHTML = skeletons.map((s, index) => `
                <div class="skeleton-card" data-index="${index}">
                    <div class="skeleton-card-header">
                        <span class="skeleton-creator">@${s.creator_username || 'unknown'}</span>
                        <div class="skeleton-meta">
                            <span>${s.platform || 'unknown'}</span>
                            <span>${s.views ? s.views.toLocaleString() + ' views' : ''}</span>
                            <span>~${s.estimated_duration_seconds || 0}s</span>
                        </div>
                    </div>
                    <div class="skeleton-card-body">
                        <div class="skeleton-section">
                            <div class="skeleton-label">Hook</div>
                            <div class="skeleton-hook">"${escapeHtml(s.hook || '')}"</div>
                        </div>
                        <div class="skeleton-section">
                            <div class="skeleton-label">Value</div>
                            <div class="skeleton-value">${escapeHtml(s.value || '')}</div>
                            ${s.value_points && s.value_points.length > 0 ? `
                                <ul class="skeleton-points">
                                    ${s.value_points.map(p => `<li>${escapeHtml(p)}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                        <div class="skeleton-section">
                            <div class="skeleton-label">CTA</div>
                            <div class="skeleton-cta">${escapeHtml(s.cta || 'None')}</div>
                        </div>
                        <div class="skeleton-tags">
                            <span class="skeleton-tag technique">${s.hook_technique || 'unknown'}</span>
                            <span class="skeleton-tag structure">${s.value_structure || 'unknown'}</span>
                            <span class="skeleton-tag">${s.cta_type || 'none'} CTA</span>
                            <span class="skeleton-tag">${s.hook_word_count || 0} word hook</span>
                        </div>
                    </div>
                    <div class="skeleton-card-actions">
                        <button class="skeleton-action-btn" onclick="openSkeletonDetail(${index})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            Details
                        </button>
                        <button class="skeleton-action-btn video-btn" id="videoBtn-${s.video_id}" onclick="handleSkeletonVideo(${index})" data-video-id="${s.video_id}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="download-icon">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="play-icon" style="display:none;">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span class="btn-text">Download</span>
                        </button>
                    </div>
                </div>
            `).join('');

            // Check video status for each skeleton
            checkAllVideoStatus();
        }

        // =========================================================
        // SKELETON MODAL FUNCTIONS
        // =========================================================

        // Check all video download status
        async function checkAllVideoStatus() {
            if (!currentReportData.reportId || !currentSkeletons.length) return;

            for (const skeleton of currentSkeletons) {
                if (!skeleton.video_id) continue;

                try {
                    const response = await fetch(`/api/skeleton-ripper/video/${currentReportData.reportId}/${skeleton.video_id}/status`);
                    if (response.ok) {
                        const data = await response.json();
                        skeletonVideoStatus[skeleton.video_id] = data.downloaded;
                        if (data.downloaded) {
                            updateVideoButton(skeleton.video_id, true);
                        }
                    }
                } catch (e) {
                    console.debug('Video status check failed for', skeleton.video_id);
                }
            }
        }

        // Update video button appearance
        function updateVideoButton(videoId, isDownloaded) {
            const btn = document.getElementById(`videoBtn-${videoId}`);
            if (!btn) return;

            const downloadIcon = btn.querySelector('.download-icon');
            const playIcon = btn.querySelector('.play-icon');
            const btnText = btn.querySelector('.btn-text');

            if (isDownloaded) {
                btn.classList.add('downloaded');
                btn.classList.remove('downloading');
                downloadIcon.style.display = 'none';
                playIcon.style.display = 'block';
                btnText.textContent = 'View Reel';
            } else {
                btn.classList.remove('downloaded', 'downloading');
                downloadIcon.style.display = 'block';
                playIcon.style.display = 'none';
                btnText.textContent = 'Download';
            }
        }

        // Open skeleton detail modal
        // Track current skeleton being viewed in detail modal
        let currentDetailIndex = null;

        // Format number with K/M suffixes
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function openSkeletonDetail(index) {
            const skeleton = currentSkeletons[index];
            if (!skeleton) return;

            currentDetailIndex = index;

            // Populate stats
            document.getElementById('statViews').textContent = formatNumber(skeleton.views);
            document.getElementById('statLikes').textContent = formatNumber(skeleton.likes);
            document.getElementById('statDuration').textContent = `~${skeleton.estimated_duration_seconds || 0}s`;

            // URL
            const url = skeleton.url || '';
            document.getElementById('skeletonDetailUrl').value = url;

            // Hook with creator prefix
            const hookText = skeleton.hook || 'No hook available';
            document.getElementById('skeletonDetailHook').textContent = hookText;

            // Transcript
            const transcript = skeleton.transcript || '';
            document.getElementById('skeletonDetailTranscript').textContent =
                transcript || 'Transcript not available. Run a new analysis to capture transcripts.';

            // Set link
            const link = document.getElementById('skeletonDetailLink');
            if (url) {
                link.href = url;
                link.style.display = 'flex';
            } else {
                link.style.display = 'none';
            }

            // Update download button state
            const downloadBtn = document.getElementById('skeletonDetailDownloadBtn');
            const isDownloaded = skeletonVideoStatus[skeleton.video_id];
            if (isDownloaded) {
                downloadBtn.textContent = 'DOWNLOADED ';
                downloadBtn.classList.add('downloaded');
            } else {
                downloadBtn.textContent = 'DOWNLOAD';
                downloadBtn.classList.remove('downloaded');
            }

            // Show modal
            document.getElementById('skeletonDetailModal').classList.add('active');
        }

        function closeSkeletonDetailModal() {
            document.getElementById('skeletonDetailModal').classList.remove('active');
            currentDetailIndex = null;
        }

        // Copy URL from detail modal
        function copySkeletonUrl() {
            const url = document.getElementById('skeletonDetailUrl').value;
            if (url) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('URL copied');
                });
            }
        }

        // Copy transcript from detail modal
        function copySkeletonDetailTranscript() {
            const transcript = document.getElementById('skeletonDetailTranscript').textContent;
            if (transcript && transcript !== 'Transcript not available. Run a new analysis to capture transcripts.') {
                navigator.clipboard.writeText(transcript).then(() => {
                    showToast('Transcript copied');
                });
            } else {
                showToast('No transcript available', 'error');
            }
        }

        // Handle download from detail modal
        async function handleDetailDownload() {
            if (currentDetailIndex === null) return;

            const skeleton = currentSkeletons[currentDetailIndex];
            if (!skeleton || !skeleton.video_id) {
                showToast('Video not available', 'error');
                return;
            }

            const isDownloaded = skeletonVideoStatus[skeleton.video_id];
            if (isDownloaded) {
                // Already downloaded - open video player
                closeSkeletonDetailModal();
                openSkeletonVideoModal(currentDetailIndex);
            } else {
                // Download the video
                const btn = document.getElementById('skeletonDetailDownloadBtn');
                btn.textContent = 'DOWNLOADING...';
                btn.classList.add('downloading');

                await downloadSkeletonVideo(currentDetailIndex);

                // Update button state
                if (skeletonVideoStatus[skeleton.video_id]) {
                    btn.textContent = 'DOWNLOADED ';
                    btn.classList.remove('downloading');
                    btn.classList.add('downloaded');
                } else {
                    btn.textContent = 'DOWNLOAD';
                    btn.classList.remove('downloading', 'downloaded');
                }
            }
        }

        // Handle video button click (download or play)
        async function handleSkeletonVideo(index) {
            const skeleton = currentSkeletons[index];
            if (!skeleton || !skeleton.video_id) {
                showToast('Video not available', 'error');
                return;
            }

            const videoId = skeleton.video_id;
            const isDownloaded = skeletonVideoStatus[videoId];

            if (isDownloaded) {
                // Open video player modal
                openSkeletonVideoModal(index);
            } else {
                // Download the video
                await downloadSkeletonVideo(index);
            }
        }

        // Download skeleton video
        async function downloadSkeletonVideo(index) {
            const skeleton = currentSkeletons[index];
            if (!skeleton || !skeleton.video_id || !currentReportData.reportId) {
                showToast('Cannot download video', 'error');
                return;
            }

            const videoId = skeleton.video_id;
            const btn = document.getElementById(`videoBtn-${videoId}`);
            const btnText = btn?.querySelector('.btn-text');

            // Set downloading state
            if (btn) {
                btn.classList.add('downloading');
                if (btnText) btnText.textContent = 'Downloading...';
            }

            try {
                const response = await fetch(`/api/skeleton-ripper/video/${currentReportData.reportId}/${videoId}/download`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        skeletonVideoStatus[videoId] = true;
                        updateVideoButton(videoId, true);
                        showToast('Video downloaded successfully');
                    } else {
                        throw new Error(data.error || 'Download failed');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Download failed');
                }
            } catch (error) {
                console.error('Video download error:', error);
                showToast(error.message || 'Failed to download video', 'error');
                updateVideoButton(videoId, false);
            }
        }

        // Open video player modal
        function openSkeletonVideoModal(index) {
            const skeleton = currentSkeletons[index];
            if (!skeleton || !skeleton.video_id || !currentReportData.reportId) {
                showToast('Video not available', 'error');
                return;
            }

            // Set video source
            const videoUrl = `/api/skeleton-ripper/video/${currentReportData.reportId}/${skeleton.video_id}`;
            const video = document.getElementById('skeletonVideoPlayer');
            const source = document.getElementById('skeletonVideoSource');

            source.src = videoUrl;
            video.load();

            // Set info
            document.getElementById('skeletonVideoUsername').textContent = `@${skeleton.creator_username || 'unknown'}`;
            document.getElementById('skeletonVideoStats').textContent =
                `${skeleton.views ? skeleton.views.toLocaleString() : '0'} views  ${skeleton.likes ? skeleton.likes.toLocaleString() : '0'} likes`;

            // Set transcript
            document.getElementById('skeletonVideoTranscript').textContent = skeleton.transcript || 'Transcript not available.';

            // Show modal
            document.getElementById('skeletonVideoModal').classList.add('active');
        }

        function closeSkeletonVideoModal() {
            const video = document.getElementById('skeletonVideoPlayer');
            video.pause();
            document.getElementById('skeletonVideoModal').classList.remove('active');
        }

        // Copy skeleton transcript from video modal
        function copySkeletonTranscript() {
            const transcript = document.getElementById('skeletonVideoTranscript').textContent;
            navigator.clipboard.writeText(transcript).then(() => {
                showToast('Transcript copied');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // =========================================================

        // Render markdown tab
        function renderMarkdownTab(markdown) {
            document.getElementById('markdownPreview').innerHTML = formatMarkdownPreview(markdown);
            document.getElementById('markdownRaw').textContent = markdown;
        }

        // Render JSON tab with syntax highlighting
        function renderJsonTab(jsonData) {
            const jsonView = document.getElementById('jsonView');
            jsonView.innerHTML = syntaxHighlightJson(JSON.stringify(jsonData, null, 2));
        }

        function syntaxHighlightJson(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Render AI Prompt tab
        function renderAiPromptTab(skeletons) {
            const promptBox = document.getElementById('aiPromptBox');

            if (!skeletons || skeletons.length === 0) {
                promptBox.textContent = 'No skeleton data available to generate prompt.';
                return;
            }

            // Build skeleton summaries
            const skeletonSummaries = skeletons.map((s, i) => `
SKELETON ${i + 1} (@${s.creator_username}):
- Hook Technique: ${s.hook_technique}
- Hook: "${s.hook}"
- Value Structure: ${s.value_structure}
- CTA Type: ${s.cta_type}
- Duration: ~${s.estimated_duration_seconds}s`).join('\n');

            const prompt = `You are a content strategist helping me create short-form video scripts based on proven skeleton patterns.

I've analyzed successful content and extracted these skeleton templates:

${skeletonSummaries}

---

HOW TO USE THIS:
1. I'll tell you what topic/product/idea I want to create content about
2. You'll help me pick the best skeleton pattern for my goal
3. We'll work together to fill in the template with my specific content
4. You'll generate a complete script I can use

GUIDELINES:
- Keep hooks punchy and under 15 words
- Match the energy and style of the original creators
- Adapt the skeleton to my niche while keeping what works
- Suggest multiple hook variations when relevant
- Flag if my content might not fit the chosen skeleton

I'm ready to create content. What topic or idea would you like to turn into a script?`;

            promptBox.textContent = prompt;
        }

        // Copy functions
        function copyMarkdown() {
            if (!currentReportData.markdown) {
                showToast('No markdown to copy', 'error');
                return;
            }
            navigator.clipboard.writeText(currentReportData.markdown).then(() => {
                showToast('Markdown copied');
            }).catch(() => {
                showToast('Copy failed', 'error');
            });
        }

        function copyJson() {
            if (!currentReportData.json || currentReportData.json.length === 0) {
                showToast('No JSON to copy', 'error');
                return;
            }
            navigator.clipboard.writeText(JSON.stringify(currentReportData.json, null, 2)).then(() => {
                showToast('JSON copied');
            }).catch(() => {
                showToast('Copy failed', 'error');
            });
        }

        function copyAiPrompt() {
            const prompt = document.getElementById('aiPromptBox').textContent;
            if (!prompt) {
                showToast('No prompt to copy', 'error');
                return;
            }
            navigator.clipboard.writeText(prompt).then(() => {
                showToast('AI prompt copied');
            }).catch(() => {
                showToast('Copy failed', 'error');
            });
        }

        function downloadJson() {
            if (!currentReportData.json || currentReportData.json.length === 0) {
                showToast('No JSON data to download', 'error');
                return;
            }
            const blob = new Blob([JSON.stringify(currentReportData.json, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skeletons_${currentReportData.reportId || 'export'}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('JSON downloaded');
        }

        function downloadMarkdown() {
            if (!currentReportData.markdown) {
                showToast('No markdown to download', 'error');
                return;
            }
            const blob = new Blob([currentReportData.markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${currentReportData.reportId || 'export'}.md`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Markdown downloaded');
        }

        // Markdown preview formatting
        function formatMarkdownPreview(markdown) {
            // Normalize line endings and split
            const lines = markdown.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            let html = '';
            let inList = false;
            let inCodeBlock = false;

            for (let rawLine of lines) {
                const line = rawLine.trimEnd(); // Remove trailing whitespace but preserve leading

                // Handle code blocks - check for ``` at start
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) {
                        html += '</code></pre>';
                        inCodeBlock = false;
                    } else {
                        html += '<pre><code>';
                        inCodeBlock = true;
                    }
                    continue;
                }
                if (inCodeBlock) {
                    html += escapeHtml(line) + '\n';
                    continue;
                }

                // Horizontal rule
                if (line.trim() === '---' || line.trim() === '***') {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<hr>';
                    continue;
                }

                // Headers - use startsWith for reliability
                if (line.startsWith('#### ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h4>${escapeHtml(line.slice(5))}</h4>`;
                    continue;
                }
                if (line.startsWith('### ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h3>${escapeHtml(line.slice(4))}</h3>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h2>${escapeHtml(line.slice(3))}</h2>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h1>${escapeHtml(line.slice(2))}</h1>`;
                    continue;
                }

                // List items
                if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += `<li>${formatInline(line.trim().slice(2))}</li>`;
                    continue;
                }

                // End list if we hit non-list content
                if (inList && line.trim() && !line.trim().startsWith('-') && !line.trim().startsWith('*')) {
                    html += '</ul>';
                    inList = false;
                }

                // Empty line
                if (!line.trim()) {
                    if (inList) { html += '</ul>'; inList = false; }
                    continue;
                }

                // Regular paragraph
                html += `<p>${formatInline(line)}</p>`;
            }

            if (inList) html += '</ul>';
            if (inCodeBlock) html += '</code></pre>';
            return html;
        }

        function formatReport(markdown) {
            // Process line by line for better control
            const lines = markdown.split('\n');
            let html = '';
            let inList = false;
            let inCodeBlock = false;

            for (let line of lines) {
                // Handle code blocks
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) {
                        html += '</pre>';
                        inCodeBlock = false;
                    } else {
                        html += '<pre><code>';
                        inCodeBlock = true;
                    }
                    continue;
                }

                if (inCodeBlock) {
                    html += escapeHtml(line) + '\n';
                    continue;
                }

                // Horizontal rule
                if (line.trim() === '---' || line.trim() === '***') {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<hr>';
                    continue;
                }

                // Headers
                if (line.startsWith('### ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h3>${formatInline(line.slice(4))}</h3>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h2>${formatInline(line.slice(3))}</h2>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h1>${formatInline(line.slice(2))}</h1>`;
                    continue;
                }

                // List items
                if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += `<li>${formatInline(line.trim().slice(2))}</li>`;
                    continue;
                }

                // End list if not a list item
                if (inList && line.trim() && !line.trim().startsWith('-') && !line.trim().startsWith('*')) {
                    html += '</ul>';
                    inList = false;
                }

                // Empty line
                if (!line.trim()) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<br>';
                    continue;
                }

                // Regular paragraph
                html += `<p>${formatInline(line)}</p>`;
            }

            if (inList) html += '</ul>';
            if (inCodeBlock) html += '</code></pre>';

            html += `
                <div class="report-actions">
                    <button class="action-btn primary" onclick="downloadReport()">DOWNLOAD REPORT</button>
                    <button class="action-btn" onclick="copyReport()">COPY TO CLIPBOARD</button>
                    <button class="action-btn" onclick="newAnalysis()">NEW ANALYSIS</button>
                </div>
            `;

            return html;
        }

        function formatInline(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>');
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showError(errors) {
            const section = document.getElementById('progressSection');
            section.innerHTML += `
                <div class="error-box">
                    <h4>ERRORS</h4>
                    <ul>
                        ${(errors || ['Unknown error']).map(e => `<li>${e}</li>`).join('')}
                    </ul>
                </div>
            `;
            document.getElementById('resultsStatus').textContent = 'Failed';
            document.getElementById('statusLabel').textContent = 'FAILED';
            resetStartButton();
        }

        function resetUI() {
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('reportContent').style.display = 'none';
            document.getElementById('reportTabs').classList.remove('active');
            document.getElementById('resultsStatus').textContent = 'Awaiting input';
            document.getElementById('statusLabel').textContent = 'READY';
            document.getElementById('statusLabel').style.color = '';
            currentReportData = { markdown: '', json: [], reportId: null };
            resetStartButton();
        }

        function resetStartButton() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.textContent = 'INITIATE ANALYSIS';
        }

        function downloadReport() {
            // Works for both current job and history reports
            if (currentJobId) {
                window.open(`/api/skeleton-ripper/report/${currentJobId}?download=true`, '_blank');
                showToast('Report download started');
            } else if (currentHistoryId) {
                window.open(`/api/skeleton-ripper/history/${currentHistoryId}?download=true`, '_blank');
                showToast('Report download started');
            } else {
                showToast('No report to download', 'error');
            }
        }

        function copyReport() {
            const content = document.getElementById('reportContent').innerText;
            if (!content) {
                showToast('No report to copy', 'error');
                return;
            }
            navigator.clipboard.writeText(content).then(() => {
                showToast('Report copied');
            }).catch(() => {
                showToast('Copy failed', 'error');
            });
        }

        function newAnalysis() {
            currentJobId = null;
            currentHistoryId = null;
            currentReportData = { markdown: '', json: [], reportId: null };
            resetUI();
            // Clear active state from history items
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
        }

        // Mission History Functions
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="history-empty">Loading...</div>';

            try {
                const response = await fetch('/api/skeleton-ripper/history');
                const data = await response.json();

                if (!data.success || !data.history || data.history.length === 0) {
                    historyList.innerHTML = '<div class="history-empty">No past missions found</div>';
                    return;
                }

                historyList.innerHTML = '';
                data.history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item' + (item.id === currentHistoryId ? ' active' : '');
                    div.onclick = () => loadHistoryReport(item.id);

                    // Primary creator name + tooltip for multiple
                    const primaryCreator = item.creators.length > 0 ? '@' + item.creators[0] : 'Unknown';
                    const tooltipHtml = item.creators.length > 1
                        ? `<div class="creator-tooltip">${item.creators.map(c => '<div>@' + c + '</div>').join('')}</div>`
                        : '';
                    const creatorSuffix = item.creators.length > 1 ? ` <span style="opacity:0.6">+${item.creators.length - 1}</span>` : '';

                    div.innerHTML = `
                        <div class="history-info">
                            <div class="history-meta">
                                <span>${item.date}</span>
                                <span class="platform">${item.platform}</span>
                            </div>
                            <span class="history-creator">${primaryCreator}${creatorSuffix}${tooltipHtml}</span>
                        </div>
                        <div class="history-stat">
                            <span class="count">${item.skeleton_count}</span>
                            <span class="label">skel</span>
                        </div>
                    `;
                    historyList.appendChild(div);
                });

            } catch (error) {
                console.error('Failed to load history:', error);
                historyList.innerHTML = '<div class="history-empty">Failed to load history</div>';
            }
        }

        async function loadHistoryReport(reportId) {
            console.log('Loading historical report:', reportId);
            currentHistoryId = reportId;

            // Update active state in history list
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find and activate the clicked item
            loadHistory();

            // Show loading in results area
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('reportContent').style.display = 'none';
            document.getElementById('reportTabs').classList.remove('active');
            document.getElementById('progressPhase').textContent = 'Loading historical report...';
            document.getElementById('progressBar').style.width = '50%';
            document.getElementById('resultsStatus').textContent = 'Loading';

            try {
                // Fetch both markdown and JSON in parallel
                const [mdResponse, jsonResponse] = await Promise.all([
                    fetch(`/api/skeleton-ripper/history/${reportId}`),
                    fetch(`/api/skeleton-ripper/history/${reportId}/json`)
                ]);

                if (!mdResponse.ok) {
                    throw new Error(`Failed to fetch report: ${mdResponse.status}`);
                }

                const markdown = await mdResponse.text();
                let jsonData = [];
                if (jsonResponse.ok) {
                    jsonData = await jsonResponse.json();
                }

                // Store report data
                currentReportData = { markdown, json: jsonData, reportId };

                // Hide progress, show tabbed interface
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('reportContent').style.display = 'none';
                document.getElementById('reportTabs').classList.add('active');

                // Render all tabs
                renderVisualSkeletons(jsonData);
                renderMarkdownTab(markdown);
                renderJsonTab(jsonData);
                renderAiPromptTab(jsonData);

                // Reset to first tab
                switchTab('visual');

                // Update status
                document.getElementById('resultsStatus').textContent = 'Historical Report';
                document.getElementById('statusLabel').textContent = 'VIEWING';
                document.getElementById('statusLabel').style.color = 'var(--color-accent-primary)';

            } catch (error) {
                console.error('Failed to load historical report:', error);
                document.getElementById('progressPhase').textContent = 'Failed to load report';
                document.getElementById('resultsStatus').textContent = 'Error';
            }
        }

        function formatHistoryReport(markdown) {
            // Use same processing as formatReport
            const lines = markdown.split('\n');
            let html = '';
            let inList = false;
            let inCodeBlock = false;

            for (let line of lines) {
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) { html += '</pre>'; inCodeBlock = false; }
                    else { html += '<pre><code>'; inCodeBlock = true; }
                    continue;
                }
                if (inCodeBlock) { html += escapeHtml(line) + '\n'; continue; }
                if (line.trim() === '---' || line.trim() === '***') {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<hr>'; continue;
                }
                if (line.startsWith('### ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h3>${formatInline(line.slice(4))}</h3>`; continue;
                }
                if (line.startsWith('## ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h2>${formatInline(line.slice(3))}</h2>`; continue;
                }
                if (line.startsWith('# ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h1>${formatInline(line.slice(2))}</h1>`; continue;
                }
                if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += `<li>${formatInline(line.trim().slice(2))}</li>`; continue;
                }
                if (inList && line.trim() && !line.trim().startsWith('-') && !line.trim().startsWith('*')) {
                    html += '</ul>'; inList = false;
                }
                if (!line.trim()) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<br>'; continue;
                }
                html += `<p>${formatInline(line)}</p>`;
            }

            if (inList) html += '</ul>';
            if (inCodeBlock) html += '</code></pre>';

            html += `
                <div class="report-actions">
                    <button class="action-btn primary" onclick="downloadHistoryReport()">DOWNLOAD REPORT</button>
                    <button class="action-btn" onclick="copyReport()">COPY TO CLIPBOARD</button>
                    <button class="action-btn" onclick="newAnalysis()">NEW ANALYSIS</button>
                </div>
            `;

            return html;
        }

        function downloadHistoryReport() {
            if (!currentHistoryId) {
                showToast('No report to download', 'error');
                return;
            }
            window.open(`/api/skeleton-ripper/history/${currentHistoryId}?download=true`, '_blank');
            showToast('Report download started');
        }

        // Load history on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
        });
    </script>
</body>
</html>
